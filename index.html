<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡å¤ä¿¡ä»»åšå¼ˆå®éªŒ</title>
    <!-- å¼•å…¥ SheetJS åº“ä»¥ç”Ÿæˆ Excel æ–‡ä»¶ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            padding: 40px;
            text-align: center;
        }
        
        h1 {
            font-size: 42px;
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 700;
        }
        
        p {
            font-size: 28px;
            line-height: 1.6;
            color: #34495e;
            margin-bottom: 25px;
        }
        
        .instructions {
            font-size: 26px;
            line-height: 1.6;
            text-align: left;
            background-color: #f9f9f9;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 40px;
        }
        
        .button {
            padding: 18px 35px;
            font-size: 26px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            min-width: 160px;
            flex: 1;
            max-width: 280px;
        }
        
        .button-primary {
            background-color: #3498db;
            color: white;
        }
        
        .button-primary:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
        }
        
        .button-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .button-secondary:hover {
            background-color: #7f8c8d;
            transform: translateY(-3px);
        }
        
        .button-success {
            background-color: #2ecc71;
            color: white;
            font-size: 28px;
            padding: 20px 40px;
        }
        
        .button-success:hover {
            background-color: #27ae60;
            transform: translateY(-3px);
        }
        
        .rating-container {
            display: flex;
            justify-content: space-between;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .rating-item {
            flex: 0 0 100%;
            margin-bottom: 30px;
        }
        
        .rating-label {
            font-size: 26px;
            margin-bottom: 25px;
            color: #2c3e50;
            text-align: center;
        }
        
        .rating-scale {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .rating-button {
            width: 70px;
            height: 70px;
            border: 4px solid #3498db;
            background-color: white;
            border-radius: 50%;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rating-button:hover, .rating-button.selected {
            background-color: #3498db;
            color: white;
            transform: scale(1.1);
        }
        
        .rating-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 22px;
            color: #7f8c8d;
            padding: 0 20px;
        }
        
        .fixation {
            font-size: 80px;
            font-weight: bold;
            color: #2c3e50;
            margin: 60px 0;
        }
        
        .decision-container {
            margin: 30px 0;
        }
        
        .avatar {
            width: 200px;
            height: 200px;
            background-color: #ecf0f1;
            border-radius: 50%;
            margin: 30px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 80px;
            color: #7f8c8d;
            border: 5px solid #bdc3c7;
        }
        
        .avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .decision-options {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin-top: 40px;
        }
        
        .decision-option {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .decision-button {
            width: 200px;
            height: 200px;
            border: none;
            border-radius: 15px;
            font-size: 36px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .invest-button {
            background-color: #2ecc71;
            color: white;
        }
        
        .invest-button:hover {
            background-color: #27ae60;
            transform: scale(1.05);
        }
        
        .keep-button {
            background-color: #e74c3c;
            color: white;
        }
        
        .keep-button:hover {
            background-color: #c0392b;
            transform: scale(1.05);
        }
        
        .key-hint {
            font-size: 24px;
            color: #7f8c8d;
            margin-top: 10px;
        }
        
        .feedback {
            font-size: 34px;
            font-weight: bold;
            margin: 40px 0;
            padding: 30px;
            border-radius: 15px;
        }
        
        .success {
            color: #27ae60;
            background-color: rgba(46, 204, 113, 0.1);
            border: 3px solid #2ecc71;
        }
        
        .failure {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            border: 3px solid #e74c3c;
        }
        
        .waiting {
            color: #f39c12;
            background-color: rgba(243, 156, 18, 0.1);
            border: 3px solid #f39c12;
        }
        
        .bold {
            font-weight: 900;
            font-size: 36px;
        }
        
        .progress-bar {
            height: 12px;
            background-color: #ecf0f1;
            border-radius: 6px;
            margin: 30px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            font-size: 24px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .block-indicator {
            font-size: 26px;
            color: #3498db;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .practice-notice {
            font-size: 30px;
            color: #e67e22;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(230, 126, 34, 0.1);
            border-radius: 10px;
        }
        
        .data-info {
            font-size: 22px;
            color: #7f8c8d;
            margin-top: 15px;
            line-height: 1.4;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 36px;
            }
            
            p, .instructions {
                font-size: 24px;
            }
            
            .button {
                padding: 15px 25px;
                font-size: 24px;
                min-width: 140px;
            }
            
            .button-success {
                font-size: 24px;
                padding: 18px 30px;
            }
            
            .decision-options {
                flex-direction: column;
                gap: 30px;
            }
            
            .decision-button {
                width: 180px;
                height: 180px;
                font-size: 32px;
            }
            
            .rating-scale {
                gap: 15px;
            }
            
            .rating-button {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <!-- æ¬¢è¿é¡µé¢ -->
        <div id="welcome-screen">
            <h1>æ¬¢è¿å‚åŠ å®éªŒï¼</h1>
            <p>è¯·ç‚¹å‡»å¼€å§‹æŒ‰é’®ç»§ç»­</p>
            <div class="button-container">
                <button class="button button-primary" id="start-button">å¼€å§‹å®éªŒ</button>
            </div>
        </div>
        
        <!-- æƒ…å¢ƒä»‹ç»é¡µé¢ -->
        <div id="scenario-screen" class="hidden">
            <p id="scenario-text"></p>
            <div class="button-container">
                <button class="button button-secondary" id="prev-button">è¿”å›ä¸Šä¸€é¡µ</button>
                <button class="button button-primary" id="next-button">ç»§ç»­(J)</button>
            </div>
        </div>
        
        <!-- è¯„åˆ†é¡µé¢1 -->
        <div id="rating1-screen" class="hidden">
            <p>åœ¨æ‚¨åˆšæ‰æƒ³è±¡çš„æƒ…å¢ƒä¸­, æ‚¨è®¤ä¸ºè‡ªå·±åœ¨å¤šå¤§ç¨‹åº¦ä¸Šæ˜¯å—ä»–äººå¸®åŠ©çš„å—åŠ©è€…ï¼Ÿ</p>
            <div class="rating-container">
                <div class="rating-item">
                    <div class="rating-label">å—åŠ©ç¨‹åº¦</div>
                    <div class="rating-scale" id="rating1-scale">
                        <button class="rating-button" data-value="1">1</button>
                        <button class="rating-button" data-value="2">2</button>
                        <button class="rating-button" data-value="3">3</button>
                        <button class="rating-button" data-value="4">4</button>
                        <button class="rating-button" data-value="5">5</button>
                        <button class="rating-button" data-value="6">6</button>
                        <button class="rating-button" data-value="7">7</button>
                    </div>
                    <div class="rating-labels">
                        <span>éå¸¸ä½</span>
                        <span>éå¸¸é«˜</span>
                    </div>
                </div>
            </div>
            <div class="button-container">
                <button class="button button-secondary" id="rating1-prev">è¿”å›ä¸Šä¸€é¡µ</button>
                <button class="button button-primary" id="rating1-next" disabled>ç»§ç»­</button>
            </div>
        </div>
        
        <!-- è¯„åˆ†é¡µé¢2 -->
        <div id="rating2-screen" class="hidden">
            <p>åœ¨æ‚¨åˆšæ‰æƒ³è±¡çš„æƒ…å¢ƒä¸­, å¸®åŠ©è¡Œä¸ºå‘ç”Ÿçš„æ¬¡æ•°å¦‚ä½•ï¼Ÿå¤šè¿˜æ˜¯å°‘ï¼Ÿ</p>
            <div class="rating-container">
                <div class="rating-item">
                    <div class="rating-label">å¸®åŠ©æ¬¡æ•°</div>
                    <div class="rating-scale" id="rating2-scale">
                        <button class="rating-button" data-value="1">1</button>
                        <button class="rating-button" data-value="2">2</button>
                        <button class="rating-button" data-value="3">3</button>
                        <button class="rating-button" data-value="4">4</button>
                        <button class="rating-button" data-value="5">5</button>
                        <button class="rating-button" data-value="6">6</button>
                        <button class="rating-button" data-value="7">7</button>
                    </div>
                    <div class="rating-labels">
                        <span>éå¸¸å°‘</span>
                        <span>éå¸¸å¤š</span>
                    </div>
                </div>
            </div>
            <div class="button-container">
                <button class="button button-secondary" id="rating2-prev">è¿”å›ä¸Šä¸€é¡µ</button>
                <button class="button button-primary" id="rating2-next" disabled>ç»§ç»­</button>
            </div>
        </div>
        
        <!-- æ³¨è§†ç‚¹é¡µé¢ -->
        <div id="fixation-screen" class="hidden">
            <div class="fixation">+</div>
        </div>
        
        <!-- æŒ‡å¯¼è¯­é¡µé¢ -->
        <div id="instruction-screen" class="hidden">
            <h1>å®éªŒæŒ‡å¯¼è¯­</h1>
            <div class="instructions">
                <p>åœ¨æœ¬å®éªŒä¸­ï¼Œæ‚¨å°†ä¸å¦ä¸€ååŒ¿åå‚ä¸è€…é…å¯¹ï¼Œé‡å¤è¿›è¡Œå¤šè½®å†³ç­–ã€‚</p>
                <br>
                <p>æ‚¨çš„è§’è‰²æ˜¯æŠ•èµ„æ–¹ã€‚æ¯è½®æ‚¨å°†è·å¾—5å…ƒã€‚æ‚¨éœ€è¦å†³å®šæ˜¯å¦å°†è¿™5å…ƒåˆ†äº«ç»™å¯¹æ–¹ï¼š</p>
                <br>
                <p>è‹¥é€‰æ‹©ä¸åˆ†äº«ï¼Œæœ¬è½®ç»“æŸã€‚æ‚¨è·å¾—5å…ƒï¼Œå¯¹æ–¹è·å¾—0å…ƒã€‚</p>
                <br>
                <p>è‹¥é€‰æ‹©åˆ†äº«ï¼Œé‡‘é¢å°†ä¸‰å€è†¨èƒ€ï¼Œå¯¹æ–¹å°†æ”¶åˆ°15å…ƒï¼Œå¹¶ç”±å¯¹æ–¹å†³å®šæ˜¯å¦å›æŠ¥ï¼š</p>
                <br>
                <p>è‹¥å¯¹æ–¹å›æŠ¥ï¼šæ‚¨ä¸å¯¹æ–¹å„å¾—7.5å…ƒã€‚</p>
                <br>
                <p>è‹¥å¯¹æ–¹ä¸å›æŠ¥ï¼šæ‚¨å¾—0å…ƒï¼Œå¯¹æ–¹å¾—15å…ƒã€‚</p>
            </div>
            <div class="button-container">
                <button class="button button-primary" id="instruction-next">æˆ‘æ˜ç™½äº†ï¼Œå¼€å§‹ç»ƒä¹ </button>
            </div>
        </div>
        
        <!-- ç»ƒä¹ å¼€å§‹æç¤º -->
        <div id="practice-start-screen" class="hidden">
            <h1>ç»ƒä¹ é˜¶æ®µ</h1>
            <p class="practice-notice">æ¥ä¸‹æ¥å°†è¿›è¡Œ4æ¬¡ç»ƒä¹ è¯•æ¬¡</p>
            <p>åœ¨ç»ƒä¹ é˜¶æ®µï¼Œæ‚¨å°†ç†Ÿæ‚‰å®éªŒæµç¨‹å’Œæ“ä½œæ–¹å¼ã€‚</p>
            <p>ç»ƒä¹ è¯•æ¬¡ä¸è®¡å…¥æ­£å¼å®éªŒæ•°æ®ã€‚</p>
            <div class="button-container">
                <button class="button button-primary" id="practice-start-button">å¼€å§‹ç»ƒä¹ </button>
            </div>
        </div>
        
        <!-- å†³ç­–é¡µé¢ -->
        <div id="decision-screen" class="hidden">
            <div class="progress-text">è¿›åº¦: <span id="trial-count">0</span>/<span id="total-trials">64</span></div>
            <div class="progress-bar">
                <div class="progress" id="progress-bar"></div>
            </div>
            <div class="block-indicator" id="block-indicator"></div>
            <div id="practice-indicator" class="practice-notice hidden">ç»ƒä¹ è¯•æ¬¡</div>
            <p>æ‚¨æ”¶åˆ°äº†åˆå§‹èµ„é‡‘5å…ƒ</p>
            <div class="avatar">
                <div class="avatar-img"></div>
            </div>
            <p>å—æ‰˜æ–¹ï¼šè€ç‹</p>
            <p>è¯·æ‚¨é€‰æ‹©ï¼š</p>
            <div class="decision-options">
                <div class="decision-option">
                    <button class="decision-button invest-button" id="invest-button">æŠ•èµ„</button>
                    <div class="key-hint">(æŒ‰Fé”®æŠ•èµ„)</div>
                </div>
                <div class="decision-option">
                    <button class="decision-button keep-button" id="keep-button">ä¿ç•™</button>
                    <div class="key-hint">(æŒ‰Jé”®ä¿ç•™)</div>
                </div>
            </div>
        </div>
        
        <!-- ä¿ç•™ç»“æœé¡µé¢ -->
        <div id="keep-result-screen" class="hidden">
            <div class="feedback">
                <p>æ‚¨é€‰æ‹©äº†<span class="bold">ä¿ç•™èµ„é‡‘</span>ï¼Œæœ¬è½®æœªæŠ•èµ„</p>
            </div>
            <div class="button-container">
                <button class="button button-primary" id="keep-continue">ç»§ç»­(J)</button>
            </div>
        </div>
        
        <!-- ç­‰å¾…å›åº”é¡µé¢ -->
        <div id="waiting-screen" class="hidden">
            <div class="feedback waiting">
                <p>æ‚¨é€‰æ‹©äº†<span class="bold">æŠ•èµ„</span>ï¼Œè¯·ç­‰å¾…è€ç‹å›åº”....</p>
            </div>
        </div>
        
        <!-- æŠ•èµ„æˆåŠŸé¡µé¢ -->
        <div id="success-screen" class="hidden">
            <div class="feedback success">
                <p>å—æ‰˜æ–¹ï¼ˆè€ç‹ï¼‰é€‰æ‹©å›æŠ¥èµ„é‡‘ï¼Œæœ¬è½®æŠ•èµ„æˆåŠŸæ”¶ç›Šä¸º7.5</p>
            </div>
            <div class="button-container">
                <button class="button button-primary" id="success-continue">ç¡®è®¤(J)</button>
            </div>
        </div>
        
        <!-- æŠ•èµ„å¤±è´¥é¡µé¢ -->
        <div id="failure-screen" class="hidden">
            <div class="feedback failure">
                <p>å—æ‰˜æ–¹ï¼ˆè€ç‹ï¼‰é€‰æ‹©ç‹¬åèµ„é‡‘ï¼Œæœ¬è½®æŠ•èµ„å¤±è´¥ï¼Œæ”¶ç›Šä¸º0</p>
            </div>
            <div class="button-container">
                <button class="button button-primary" id="failure-continue">ç¡®è®¤(J)</button>
            </div>
        </div>
        
        <!-- ç»ƒä¹ ç»“æŸé¡µé¢ -->
        <div id="practice-end-screen" class="hidden">
            <h1>ç»ƒä¹ è¯•æ¬¡ç»“æŸ</h1>
            <p class="practice-notice">æ¥ä¸‹æ¥è¿›å…¥æ­£å¼å®éªŒ</p>
            <p>æ­£å¼å®éªŒåŒ…å«60ä¸ªè¯•æ¬¡ï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µã€‚</p>
            <p>è¯·æ ¹æ®æ‚¨çš„åˆ¤æ–­åšå‡ºå†³ç­–ã€‚</p>
            <div class="button-container">
                <button class="button button-primary" id="start-formal-button">å¼€å§‹æ­£å¼å®éªŒ</button>
            </div>
        </div>
        
        <!-- å®éªŒç»“æŸé¡µé¢ -->
        <div id="end-screen" class="hidden">
            <h1>æ„Ÿè°¢æ‚¨å‚åŠ æœ¬æ¬¡å®éªŒï¼</h1>
            <p>å®éªŒå·²å®Œæˆï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</p>
            <p class="data-info">æ‚¨çš„å®éªŒæ•°æ®å·²ç”Ÿæˆï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯ä¸‹è½½Excelæ ¼å¼çš„æ•°æ®æ–‡ä»¶ã€‚</p>
            <div class="button-container">
                <button class="button button-success" id="download-data-btn">ä¸‹è½½å®éªŒæ•°æ® (Excel)</button>
                <button class="button button-secondary" onclick="location.reload()">é‡æ–°å¼€å§‹å®éªŒ</button>
            </div>
        </div>
    </div>

    <script>
        // å®éªŒæ•°æ®å­˜å‚¨
        const experimentData = {
            participantId: Date.now().toString(),
            startTime: new Date().toISOString(),
            ratings: {
                helpReceived: null,
                helpFrequency: null
            },
            trials: [],
            currentTrial: 0,
            practiceTrials: 4,
            formalTrials: 60,
            totalTrials: 64,
            blockType: null,
            blockOrder: [],
            currentBlock: 0,
            isPractice: true,
            trialStartTime: null,
            currentTrialInBlock: 0
        };

        // å±å¹•å…ƒç´ 
        const screens = {
            welcome: document.getElementById('welcome-screen'),
            scenario: document.getElementById('scenario-screen'),
            rating1: document.getElementById('rating1-screen'),
            rating2: document.getElementById('rating2-screen'),
            fixation: document.getElementById('fixation-screen'),
            instruction: document.getElementById('instruction-screen'),
            practiceStart: document.getElementById('practice-start-screen'),
            decision: document.getElementById('decision-screen'),
            keepResult: document.getElementById('keep-result-screen'),
            waiting: document.getElementById('waiting-screen'),
            success: document.getElementById('success-screen'),
            failure: document.getElementById('failure-screen'),
            practiceEnd: document.getElementById('practice-end-screen'),
            end: document.getElementById('end-screen')
        };

        // æƒ…å¢ƒæ–‡æœ¬
        const scenarioTexts = [
            "æ‚¨å¥½, ç°åœ¨è¯·æ‚¨æƒ³è±¡ä»¥ä¸‹æƒ…å¢ƒ: æ‚¨æ‰€åœ¨çš„ç¤¾åŒºæ­£åœ¨å®æ–½\"æ—¶é—´é“¶è¡Œäº’åŠ©å…»è€\"æœåŠ¡é¡¹ç›®ã€‚åœ¨è¿™ä¸ªé¡¹ç›®ä¸­, æœ‰ä¸€ä½åå«è€ç‹çš„å¿—æ„¿æœåŠ¡è€…ã€‚æ‚¨ç¡®è®¤æ˜ç™½åï¼Œç‚¹å‡»\"ç»§ç»­(J)\"ã€‚",
            "åœ¨è¿‡å»åŠå¹´é‡Œ, è€ç‹ç»å¸¸ä¸ºæ‚¨æä¾›å¿—æ„¿æœåŠ¡, ç´¯è®¡å¸®åŠ©æ‚¨çº¦40æ¬¡ã€‚è€ç‹ç»å¸¸å¸®æ‚¨ä¹°èœã€é™ªæ‚¨èŠå¤©ã€ååŠ©æ‚¨å¤„ç†æ‰‹æœºé—®é¢˜ã€é™ªæ‚¨å»åŒ»é™¢çœ‹ç—…ç­‰ã€‚æ¯å½“æ‚¨éœ€è¦å¸®åŠ©æ—¶, è€ç‹æ€»æ˜¯åŠæ—¶å‡ºç°, è€å¿ƒç»†è‡´åœ°ä¸ºæ‚¨æœåŠ¡ã€‚æ‚¨ç¡®è®¤æ˜ç™½åï¼Œç‚¹å‡»\"ç»§ç»­\"ã€‚",
            "è€Œç°åœ¨, æ‚¨å°†å’Œè€ç‹ä¸€èµ·è¿›è¡Œä¸€åœºæŠ•èµ„æ¸¸æˆã€‚æ‚¨ç¡®è®¤æ˜ç™½åï¼Œç‚¹å‡»\"ç»§ç»­\"ã€‚"
        ];

        // å®éªŒå˜é‡
        let currentScenario = 0;
        let currentRating1 = null;
        let currentRating2 = null;
        let blockTypes = ['high-to-low', 'low-to-high'];
        
        // éšæœºåˆ†é…blocké¡ºåº
        experimentData.blockOrder = [...blockTypes].sort(() => Math.random() - 0.5);
        experimentData.blockType = experimentData.blockOrder[0];

        // æ˜¾ç¤ºæŒ‡å®šå±å¹•
        function showScreen(screenName) {
            // éšè—æ‰€æœ‰å±å¹•
            Object.values(screens).forEach(screen => {
                if (screen) {
                    screen.classList.add('hidden');
                }
            });
            
            // æ£€æŸ¥å±å¹•æ˜¯å¦å­˜åœ¨
            if (!screens[screenName]) {
                console.error(`å±å¹• "${screenName}" æœªæ‰¾åˆ°ï¼`);
                return;
            }
            
            // æ˜¾ç¤ºç›®æ ‡å±å¹•
            screens[screenName].classList.remove('hidden');
            
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯å†³ç­–å±ï¼Œè®°å½•å¼€å§‹æ—¶é—´
            if (screenName === 'decision') {
                experimentData.trialStartTime = Date.now();
                
                // æ›´æ–°ç»ƒä¹ /æ­£å¼å®éªŒæ ‡è¯†
                const practiceIndicator = document.getElementById('practice-indicator');
                if (experimentData.isPractice) {
                    if (practiceIndicator) practiceIndicator.classList.remove('hidden');
                } else {
                    if (practiceIndicator) practiceIndicator.classList.add('hidden');
                }
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar() {
            const progress = (experimentData.currentTrial / experimentData.totalTrials) * 100;
            const progressBar = document.getElementById('progress-bar');
            const trialCount = document.getElementById('trial-count');
            const totalTrials = document.getElementById('total-trials');
            const blockIndicator = document.getElementById('block-indicator');
            
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (trialCount) trialCount.textContent = `${experimentData.currentTrial}`;
            if (totalTrials) totalTrials.textContent = `${experimentData.totalTrials}`;
            
            // æ›´æ–°blockæŒ‡ç¤ºå™¨
            if (experimentData.isPractice) {
                if (blockIndicator) blockIndicator.textContent = "";
            } else {
                const blockNames = {
                    'high-to-low': 'ç”±é«˜åˆ°ä½ç»„',
                    'low-to-high': 'ç”±ä½åˆ°é«˜ç»„'
                };
                
                // è®¡ç®—å½“å‰blockä¸­çš„è¯•æ¬¡æ•°
                let blockTrialCount = experimentData.currentTrialInBlock;
                if (experimentData.currentBlock === 1) {
                    // ç¬¬äºŒä¸ªblockï¼Œå‡å»ç¬¬ä¸€ä¸ªblockçš„30ä¸ªè¯•æ¬¡
                    blockTrialCount = experimentData.currentTrial - experimentData.practiceTrials - 30;
                }
                
                if (blockIndicator) {
                    blockIndicator.textContent = 
                        `${blockNames[experimentData.blockType]} (${blockTrialCount}/30)`;
                }
            }
        }

        // æ ¹æ®å½“å‰è¯•æ¬¡è®¡ç®—æˆåŠŸæ¦‚ç‡
        function getSuccessProbability() {
            if (experimentData.isPractice) {
                // ç»ƒä¹ è¯•æ¬¡ï¼š50%æˆåŠŸæ¦‚ç‡
                return 0.5;
            } else {
                // æ­£å¼è¯•æ¬¡
                const blockType = experimentData.blockType;
                const trialInBlock = experimentData.currentTrialInBlock;
                
                if (blockType === 'high-to-low') {
                    // ç”±é«˜åˆ°ä½ç»„
                    if (trialInBlock <= 15) {
                        // å‰15ä¸ªè¯•æ¬¡ï¼š70%æˆåŠŸ
                        return 0.7;
                    } else {
                        // å15ä¸ªè¯•æ¬¡ï¼š50%æˆåŠŸ
                        return 0.5;
                    }
                } else {
                    // ç”±ä½åˆ°é«˜ç»„
                    if (trialInBlock <= 15) {
                        // å‰15ä¸ªè¯•æ¬¡ï¼š30%æˆåŠŸ
                        return 0.3;
                    } else {
                        // å15ä¸ªè¯•æ¬¡ï¼š50%æˆåŠŸ
                        return 0.5;
                    }
                }
            }
        }

        // å®éªŒæ•°æ®å¯¼å‡ºä¸ºExcel
        function exportToExcel() {
            // å‡†å¤‡æ•°æ®è¡Œ
            const rows = [];
            
            // ä¸ºæ¯ä¸ªè¯•æ¬¡åˆ›å»ºä¸€è¡Œæ•°æ®
            experimentData.trials.forEach(trial => {
                const row = {
                    // åŸºæœ¬ä¿¡æ¯
                    "è¢«è¯•ID": experimentData.participantId,
                    "å®éªŒå¼€å§‹æ—¶é—´": experimentData.startTime,
                    "å—åŠ©ç¨‹åº¦è¯„åˆ†": experimentData.ratings.helpReceived,
                    "å¸®åŠ©æ¬¡æ•°è¯„åˆ†": experimentData.ratings.helpFrequency,
                    
                    // è¯•æ¬¡ä¿¡æ¯
                    "è¯•æ¬¡ç¼–å·": trial.trialNumber,
                    "é˜¶æ®µ": trial.isPractice ? "ç»ƒä¹ " : "æ­£å¼",
                    "ç»„åˆ«ç±»å‹": trial.blockType === 'high-to-low' ? 'ç”±é«˜åˆ°ä½' : 'ç”±ä½åˆ°é«˜',
                    "ç»„å†…è¯•æ¬¡åºå·": trial.blockTrial,
                    "å†³ç­–": trial.decision === 'invest' ? 'æŠ•èµ„' : 'ä¿ç•™',
                    "ååº”æ—¶(ms)": trial.reactionTime,
                    "åé¦ˆ": trial.feedback === 'success' ? 'æˆåŠŸ(å›æŠ¥)' : 
                           trial.feedback === 'failure' ? 'å¤±è´¥(ç‹¬å)' : 
                           trial.feedback === 'none' ? 'æ— (é€‰æ‹©ä¿ç•™)' : trial.feedback,
                    "æ”¶ç›Š": trial.earnings !== undefined ? trial.earnings : '',
                    "æˆåŠŸæ¦‚ç‡": trial.successProbability !== undefined ? trial.successProbability : '',
                    "æ—¶é—´æˆ³": trial.timestamp
                };
                rows.push(row);
            });
            
            // å¦‚æœæ²¡æœ‰ä»»ä½•è¯•æ¬¡æ•°æ®ï¼Œæ·»åŠ ä¸€è¡ŒåŸºæœ¬ä¿¡æ¯
            if (rows.length === 0) {
                rows.push({
                    "è¢«è¯•ID": experimentData.participantId,
                    "å®éªŒå¼€å§‹æ—¶é—´": experimentData.startTime,
                    "å—åŠ©ç¨‹åº¦è¯„åˆ†": experimentData.ratings.helpReceived,
                    "å¸®åŠ©æ¬¡æ•°è¯„åˆ†": experimentData.ratings.helpFrequency,
                    "è¯•æ¬¡ç¼–å·": "æ— è¯•æ¬¡æ•°æ®",
                    "é˜¶æ®µ": "",
                    "ç»„åˆ«ç±»å‹": "",
                    "ç»„å†…è¯•æ¬¡åºå·": "",
                    "å†³ç­–": "",
                    "ååº”æ—¶(ms)": "",
                    "åé¦ˆ": "",
                    "æ”¶ç›Š": "",
                    "æˆåŠŸæ¦‚ç‡": "",
                    "æ—¶é—´æˆ³": ""
                });
            }
            
            // åˆ›å»ºå·¥ä½œè¡¨
            const worksheet = XLSX.utils.json_to_sheet(rows);
            
            // åˆ›å»ºå·¥ä½œç°¿
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "å®éªŒæ•°æ®");
            
            // ç”Ÿæˆæ–‡ä»¶å
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `ä¿¡ä»»åšå¼ˆå®éªŒæ•°æ®_${experimentData.participantId}_${timestamp}.xlsx`;
            
            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(workbook, filename);
        }

        // å¼€å§‹å®éªŒ
        document.getElementById('start-button').addEventListener('click', () => {
            showScreen('scenario');
            document.getElementById('scenario-text').textContent = scenarioTexts[0];
        });

        // æƒ…å¢ƒä»‹ç»å¯¼èˆª
        document.getElementById('next-button').addEventListener('click', () => {
            if (currentScenario < scenarioTexts.length - 1) {
                currentScenario++;
                document.getElementById('scenario-text').textContent = scenarioTexts[currentScenario];
            } else {
                showScreen('rating1');
            }
        });

        document.getElementById('prev-button').addEventListener('click', () => {
            if (currentScenario > 0) {
                currentScenario--;
                document.getElementById('scenario-text').textContent = scenarioTexts[currentScenario];
            } else {
                showScreen('welcome');
            }
        });

        // è¯„åˆ†1
        const rating1Buttons = document.querySelectorAll('#rating1-scale .rating-button');
        rating1Buttons.forEach(button => {
            button.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                rating1Buttons.forEach(btn => btn.classList.remove('selected'));
                // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
                button.classList.add('selected');
                currentRating1 = parseInt(button.getAttribute('data-value'));
                experimentData.ratings.helpReceived = currentRating1;
                document.getElementById('rating1-next').disabled = false;
            });
        });

        document.getElementById('rating1-next').addEventListener('click', () => {
            showScreen('rating2');
        });

        document.getElementById('rating1-prev').addEventListener('click', () => {
            showScreen('scenario');
        });

        // è¯„åˆ†2
        const rating2Buttons = document.querySelectorAll('#rating2-scale .rating-button');
        rating2Buttons.forEach(button => {
            button.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                rating2Buttons.forEach(btn => btn.classList.remove('selected'));
                // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
                button.classList.add('selected');
                currentRating2 = parseInt(button.getAttribute('data-value'));
                experimentData.ratings.helpFrequency = currentRating2;
                document.getElementById('rating2-next').disabled = false;
            });
        });

        document.getElementById('rating2-next').addEventListener('click', () => {
            showScreen('fixation');
            setTimeout(() => {
                showScreen('instruction');
            }, 800);
        });

        document.getElementById('rating2-prev').addEventListener('click', () => {
            showScreen('rating1');
        });

        // æŒ‡å¯¼è¯­ç»§ç»­
        document.getElementById('instruction-next').addEventListener('click', () => {
            // æ˜¾ç¤ºç»ƒä¹ å¼€å§‹é¡µé¢
            showScreen('practiceStart');
        });

        // å¼€å§‹ç»ƒä¹ 
        document.getElementById('practice-start-button').addEventListener('click', () => {
            // å¼€å§‹ç»ƒä¹ è¯•æ¬¡
            experimentData.currentTrial = 1;
            experimentData.isPractice = true;
            experimentData.currentTrialInBlock = 1;
            updateProgressBar();
            showScreen('fixation');
            setTimeout(() => {
                showScreen('decision');
            }, 800);
        });

        // å†³ç­–æŒ‰é’®äº‹ä»¶
        document.getElementById('invest-button').addEventListener('click', () => makeDecision('invest'));
        document.getElementById('keep-button').addEventListener('click', () => makeDecision('keep'));

        // é”®ç›˜äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', (event) => {
            const key = event.key.toLowerCase();
            
            // é˜²æ­¢é‡å¤æŒ‰é”®
            if (event.repeat) return;
            
            // æ ¹æ®å½“å‰å±å¹•å¤„ç†æŒ‰é”®
            if (!screens.decision.classList.contains('hidden')) {
                if (key === 'f') {
                    makeDecision('invest');
                } else if (key === 'j') {
                    makeDecision('keep');
                }
            } else if (!screens.keepResult.classList.contains('hidden')) {
                if (key === 'j') {
                    nextTrial();
                }
            } else if (!screens.success.classList.contains('hidden')) {
                if (key === 'j') {
                    nextTrial();
                }
            } else if (!screens.failure.classList.contains('hidden')) {
                if (key === 'j') {
                    nextTrial();
                }
            } else if (!screens.scenario.classList.contains('hidden')) {
                if (key === 'j') {
                    document.getElementById('next-button').click();
                }
            } else if (!screens.practiceStart.classList.contains('hidden')) {
                if (key === 'j') {
                    document.getElementById('practice-start-button').click();
                }
            } else if (!screens.practiceEnd.classList.contains('hidden')) {
                if (key === 'j') {
                    document.getElementById('start-formal-button').click();
                }
            }
        });

        // å†³ç­–å‡½æ•°
        function makeDecision(decision) {
            const reactionTime = Date.now() - experimentData.trialStartTime;
            
            // è®°å½•å†³ç­–
            const trialData = {
                trialNumber: experimentData.currentTrial,
                isPractice: experimentData.isPractice,
                blockType: experimentData.blockType,
                blockTrial: experimentData.currentTrialInBlock,
                decision: decision,
                reactionTime: reactionTime,
                timestamp: new Date().toISOString()
            };
            
            if (decision === 'keep') {
                trialData.feedback = 'none';
                trialData.earnings = 5;
                trialData.successProbability = null;
                experimentData.trials.push(trialData);
                showScreen('keepResult');
            } else {
                // æŠ•èµ„å†³ç­–ï¼Œéœ€è¦æ˜¾ç¤ºç­‰å¾…å’Œåé¦ˆ
                trialData.feedback = 'pending';
                experimentData.trials.push(trialData);
                showScreen('waiting');
                
                // è·å–å½“å‰çš„æˆåŠŸæ¦‚ç‡
                const successProbability = getSuccessProbability();
                
                // éšæœºå»¶è¿Ÿï¼ˆ1000-4000msï¼‰
                const delay = 1000 + Math.random() * 3000;
                
                setTimeout(() => {
                    // æ ¹æ®æ¦‚ç‡å†³å®šåé¦ˆ
                    const randomValue = Math.random();
                    const isSuccess = randomValue < successProbability;
                    
                    // æ›´æ–°trialæ•°æ®
                    const lastTrialIndex = experimentData.trials.length - 1;
                    experimentData.trials[lastTrialIndex].feedback = isSuccess ? 'success' : 'failure';
                    experimentData.trials[lastTrialIndex].successProbability = successProbability;
                    experimentData.trials[lastTrialIndex].earnings = isSuccess ? 7.5 : 0;
                    
                    // æ˜¾ç¤ºåé¦ˆ
                    if (isSuccess) {
                        showScreen('success');
                    } else {
                        showScreen('failure');
                    }
                }, delay);
            }
        }

        // ç»§ç»­æŒ‰é’®äº‹ä»¶
        document.getElementById('keep-continue').addEventListener('click', nextTrial);
        document.getElementById('success-continue').addEventListener('click', nextTrial);
        document.getElementById('failure-continue').addEventListener('click', nextTrial);

        // ä¸‹ä¸€ä¸ªè¯•æ¬¡
        function nextTrial() {
            experimentData.currentTrial++;
            
            if (experimentData.isPractice) {
                // ç»ƒä¹ è¯•æ¬¡
                experimentData.currentTrialInBlock++;
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆç»ƒä¹ è¯•æ¬¡
                if (experimentData.currentTrial > experimentData.practiceTrials) {
                    showScreen('practiceEnd');
                    return;
                }
            } else {
                // æ­£å¼è¯•æ¬¡
                experimentData.currentTrialInBlock++;
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆå½“å‰blockï¼ˆ30ä¸ªè¯•æ¬¡ï¼‰
                if (experimentData.currentTrialInBlock > 30) {
                    // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªblock
                    experimentData.currentBlock++;
                    
                    // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰block
                    if (experimentData.currentBlock >= experimentData.blockOrder.length) {
                        // å®éªŒç»“æŸ
                        showScreen('end');
                        // è®¾ç½®ä¸‹è½½æŒ‰é’®äº‹ä»¶
                        document.getElementById('download-data-btn').addEventListener('click', exportToExcel);
                        return;
                    } else {
                        // é‡ç½®blockè¯•æ¬¡è®¡æ•°ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªblock
                        experimentData.currentTrialInBlock = 1;
                        experimentData.blockType = experimentData.blockOrder[experimentData.currentBlock];
                    }
                }
            }
            
            updateProgressBar();
            
            // æ˜¾ç¤ºæ³¨è§†ç‚¹ç„¶åå†³ç­–å±
            showScreen('fixation');
            setTimeout(() => {
                showScreen('decision');
            }, 800);
        }

        // å¼€å§‹æ­£å¼å®éªŒ
        document.getElementById('start-formal-button').addEventListener('click', () => {
            experimentData.isPractice = false;
            experimentData.currentTrial = experimentData.practiceTrials + 1;
            experimentData.currentTrialInBlock = 1;
            experimentData.currentBlock = 0;
            updateProgressBar();
            
            showScreen('fixation');
            setTimeout(() => {
                showScreen('decision');
            }, 800);
        });

        // åˆ›å»ºè€å¹´äººå‰ªå½±å¤´åƒ
        const avatar = document.querySelector('.avatar-img');
        if (avatar) {
            avatar.style.background = 'linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%)';
            avatar.style.display = 'flex';
            avatar.style.justifyContent = 'center';
            avatar.style.alignItems = 'center';
            avatar.style.fontSize = '100px';
            avatar.textContent = 'ğŸ‘´';
        }

        // åˆå§‹åŒ–
        updateProgressBar();
    </script>
</body>
</html>